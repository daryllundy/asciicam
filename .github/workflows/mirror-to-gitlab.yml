name: Mirror to GitLab
on:
  push:
  delete:
  schedule:
    - cron: '0 0 * * *'  # Daily sync as backup

permissions:
  contents: read

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.GITLAB_USERNAME }}" ] || [ -z "${{ secrets.GITLAB_TOKEN }}" ]; then
            echo "‚ö†Ô∏è  Warning: GITLAB_USERNAME and GITLAB_TOKEN secrets are not configured"
            echo "Skipping GitLab mirror. Configure these secrets to enable mirroring."
            echo "skip_mirror=true" >> $GITHUB_ENV
          else
            echo "‚úÖ GitLab credentials are configured"
            echo "skip_mirror=false" >> $GITHUB_ENV
          fi

      - name: Checkout
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      - name: Mirror to GitLab
        if: env.skip_mirror != 'true'
        env:
          GITLAB_USERNAME: ${{ secrets.GITLAB_USERNAME }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          set -e  # Exit on any error
          
          echo "üîß Configuring git..."
          git config --global user.name "GitHub Mirror Bot"
          git config --global user.email "mirror-bot@users.noreply.github.com"

          echo "üîó Adding GitLab remote..."
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          GITLAB_URL="https://${GITLAB_USERNAME}:${GITLAB_TOKEN}@gitlab.com/${GITLAB_USERNAME}/${REPO_NAME}.git"
          
          # Remove existing remote if it exists
          git remote remove gitlab 2>/dev/null || true
          git remote add gitlab "${GITLAB_URL}"

          echo "üì§ Pushing to GitLab..."
          if ! git push gitlab --all --force; then
            echo "‚ùå Failed to push branches"
            exit 1
          fi
          
          if ! git push gitlab --tags --force; then
            echo "‚ùå Failed to push tags"
            exit 1
          fi
          
          if ! git push gitlab --prune; then
            echo "‚ùå Failed to prune remote branches"
            exit 1
          fi

          echo "‚úÖ Successfully mirrored to GitLab"

      - name: Skip mirror notification
        if: env.skip_mirror == 'true'
        run: |
          echo "‚è≠Ô∏è  Skipping GitLab mirror due to missing credentials"
          echo "To enable mirroring, configure GITLAB_USERNAME and GITLAB_TOKEN secrets"
